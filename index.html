<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>한살림 & 초록마을 서울/수도권 통합 지도</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd6QIRzWvsTTbfVUQkcqGyz-fXuQ4DTbU&libraries=geometry"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif;}
        #map { width: 100%; height: 100%; }
        
        #status-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; font-size: 14px;
        }

        .legend {
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-size: 12px;
            max-height: 50vh; overflow-y: auto; width: 200px;
        }
        .legend-title { font-weight: bold; margin-top: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; color:#333; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; cursor: pointer; }
        .legend-icon { width: 20px; height: 20px; margin-right: 5px; object-fit: contain; }
    </style>
</head>
<body>
    <div id="status-bar">지도 데이터 로딩 중...</div>
    
    <div class="legend" id="legend-box">
        </div>

    <div id="map"></div>

    <script>
        let map;
        let geocoder;
        // 인포윈도우를 전역 변수 하나로 관리하여, 새 창이 열리면 기존 창이 닫히게 함
        let currentInfoWindow = null; 
        const geocodedStores = []; 
        
        // 1. 한살림 매장 데이터
        const hansalimStores = [
            // [북서울지부] - 파랑
            {name: "미아매장", address: "서울 강북구 솔샘로 184", jibu: "북서울"},
            {name: "방학매장", address: "서울 도봉구 도봉로150길 31", jibu: "북서울"},
            {name: "상계매장", address: "서울 노원구 노원로 526", jibu: "북서울"},
            {name: "쌍문매장", address: "서울 도봉구 시루봉로6길 13", jibu: "북서울"},
            {name: "창동매장", address: "서울 도봉구 마들로 556", jibu: "북서울"},
            {name: "공릉매장", address: "서울 노원구 공릉로 188", jibu: "북서울"},
            {name: "양주고읍매장", address: "경기 양주시 고읍남로 23", jibu: "북서울"},
            {name: "의정부매장", address: "경기 의정부시 금오동 463-11", jibu: "북서울"},
            {name: "중계매장", address: "서울 노원구 한글비석로15길 15", jibu: "북서울"},
            {name: "하계매장", address: "서울 노원구 섬밭로 258", jibu: "북서울"},
            {name: "금호매장", address: "서울 성동구 금호로 100", jibu: "북서울"},
            {name: "행당매장", address: "서울 성동구 행당로 76", jibu: "북서울"},
            {name: "길음매장", address: "서울 성북구 길음로 33", jibu: "북서울"},
            {name: "돈암매장", address: "서울 성북구 아리랑로 31-1", jibu: "북서울"},
            {name: "종암매장", address: "서울 성북구 종암로24가길 53", jibu: "북서울"},
            {name: "왕십리매장", address: "서울 성동구 상왕십리동 14-15", jibu: "북서울"},
            {name: "전농매장", address: "서울 동대문구 한천로 207", jibu: "북서울"},
            {name: "광화문매장", address: "서울 종로구 경희궁길 15", jibu: "북서울"},
            {name: "이촌매장", address: "서울 용산구 이촌동 300-268", jibu: "북서울"},
            {name: "평창매장", address: "서울 종로구 평창동 158-1", jibu: "북서울"},

            // [동서울지부] - 보라
            {name: "가락매장", address: "서울 송파구 오금로46길 68", jibu: "동서울"},
            {name: "강일매장", address: "서울 강동구 강일동 503", jibu: "동서울"},
            {name: "둔촌매장", address: "서울 강동구 강동대로55길 77", jibu: "동서울"},
            {name: "명일매장", address: "서울 강동구 동남로73길 9", jibu: "동서울"},
            {name: "고덕매장", address: "서울 강동구 고덕로 399", jibu: "동서울"},
            {name: "송파매장", address: "서울 송파구 송이로 27", jibu: "동서울"},
            {name: "신천매장", address: "서울 송파구 올림픽로 435", jibu: "동서울"},
            {name: "잠실새내역매장", address: "서울 송파구 석촌호수로 61", jibu: "동서울"},
            {name: "암사매장", address: "서울 강동구 고덕로 109", jibu: "동서울"},
            {name: "잠실매장", address: "서울 송파구 백제고분로 150", jibu: "동서울"},
            {name: "오금매장", address: "서울 송파구 마천로 106", jibu: "동서울"},
            {name: "위례매장", address: "경기 성남시 수정구 위례동로 61", jibu: "동서울"},
            {name: "하남매장", address: "경기 하남시 신장동 587", jibu: "동서울"},
            {name: "미사매장", address: "경기 하남시 미사강변중앙로 220", jibu: "동서울"},
            {name: "광나루매장", address: "서울 광진구 천호대로 798-1", jibu: "동서울"},
            {name: "구리매장", address: "경기 구리시 장자대로86번길 38", jibu: "동서울"},
            {name: "인창매장", address: "경기 구리시 건원대로34번길 19", jibu: "동서울"},
            {name: "구의매장", address: "서울 광진구 광나루로 603", jibu: "동서울"},
            {name: "신내매장", address: "서울 중랑구 신내로15길 196", jibu: "동서울"},
            {name: "자양매장", address: "서울 광진구 능동로 50", jibu: "동서울"},
            {name: "호평매장", address: "경기 남양주시 호평로46번안길 4-21", jibu: "동서울"},
            {name: "다산매장", address: "경기 남양주시 다산순환로 397-47", jibu: "동서울"},
            {name: "별내매장", address: "경기 남양주시 별내중앙로 36-31", jibu: "동서울"},

            // [서서울지부] - 주황
            {name: "가양매장", address: "서울 강서구 양천로 556", jibu: "서서울"},
            {name: "고척매장", address: "서울 구로구 중앙로 100", jibu: "서서울"},
            {name: "마곡매장", address: "서울 강서구 마곡서1로 115-1", jibu: "서서울"},
            {name: "목동매장", address: "서울 양천구 목동동로 339", jibu: "서서울"},
            {name: "신정매장", address: "서울 양천구 목동서로 397", jibu: "서서울"},
            {name: "오목교매장", address: "서울 양천구 목동서로 256", jibu: "서서울"},
            {name: "우장산매장", address: "서울 강서구 강서로 242", jibu: "서서울"},
            {name: "구파발매장", address: "서울 은평구 진관3로 15-35", jibu: "서서울"},
            {name: "불광매장", address: "서울 은평구 통일로 738", jibu: "서서울"},
            {name: "마포매장", address: "서울 마포구 토정로 269", jibu: "서서울"},
            {name: "공덕매장", address: "서울 마포구 마포대로 156", jibu: "서서울"},
            {name: "성산매장", address: "서울 마포구 월드컵북로 216", jibu: "서서울"},
            {name: "아현매장", address: "서울 마포구 마포대로 195", jibu: "서서울"},
            {name: "연희매장", address: "서울 서대문구 연희맛로 34", jibu: "서서울"},
            {name: "홍제매장", address: "서울 서대문구 통일로 348", jibu: "서서울"},
            {name: "가재울매장", address: "서울 서대문구 거북골로 100", jibu: "서서울"},
            {name: "문래매장", address: "서울 영등포구 당산로 34", jibu: "서서울"},
            {name: "보라매매장", address: "서울 영등포구 신길로29", jibu: "서서울"},
            {name: "소하매장", address: "경기 광명시 소하로 77", jibu: "서서울"},
            {name: "여의도매장", address: "서울 영등포구 여의동로 97", jibu: "서서울"},
            {name: "철산매장", address: "경기 광명시 철산로 45", jibu: "서서울"},

            // [남서울생협] - 빨강
            {name: "개포매장", address: "서울 강남구 개포로 265", jibu: "남서울"},
            {name: "대치매장", address: "서울 강남구 삼성로 51길 11", jibu: "남서울"},
            {name: "반포매장", address: "서울 서초구 신반포로219", jibu: "남서울"},
            {name: "방배매장", address: "서울 서초구 서초대로 118", jibu: "남서울"},
            {name: "새반포매장", address: "서울 서초구 서초중앙로31길 14-13", jibu: "남서울"},
            {name: "서초매장", address: "서울 서초구 사임당로14길 15", jibu: "남서울"},
            {name: "압구정매장", address: "서울 강남구 압구정로 309", jibu: "남서울"},
            {name: "역삼매장", address: "서울 강남구 역삼동 786-24", jibu: "남서울"},
            {name: "일원매장", address: "서울 강남구 광평로10길 15", jibu: "남서울"},
            {name: "자곡매장", address: "서울 강남구 자곡로 180", jibu: "남서울"},
            {name: "청담매장", address: "서울 강남구 학동로88길 12", jibu: "남서울"},
            {name: "금천시흥매장", address: "서울 금천구 시흥동 985-13", jibu: "남서울"},
            {name: "봉천매장", address: "서울 관악구 양녕로 74", jibu: "남서울"},
            {name: "사당매장", address: "서울 동작구 동작대로29길 69", jibu: "남서울"},
            {name: "상도매장", address: "서울 동작구 상도로37길 79", jibu: "남서울"},

            // [경인지부] - 청록
            {name: "구월매장", address: "인천 남동구 용천로 29", jibu: "경인"},
            {name: "부천매장", address: "경기 부천시 조마루로105번길 34-9", jibu: "경인"},
            {name: "송도매장", address: "인천 연수구 컨벤시아대로 90", jibu: "경인"},
            {name: "옥길매장", address: "경기 부천시 옥길동 777-1", jibu: "경인"},
            {name: "장기매장", address: "경기 김포시 초당로16번길 114-5", jibu: "경인"},
            {name: "청라매장", address: "인천 서구 연희동 797-1", jibu: "경인"}
        ];

        // 2. 초록마을 매장 데이터
        const chorocStores = [
            // 강남/서초/송파
            {name: "초록마을 압구정점", address: "서울 강남구 압구정로29길 65"},
            {name: "초록마을 개포점", address: "서울 강남구 개포로82길 9-15"},
            {name: "초록마을 청담중앙점", address: "서울 강남구 학동로101길 26"},
            {name: "초록마을 대치점", address: "서울 강남구 선릉로 222"},
            {name: "초록마을 삼성점", address: "서울 강남구 삼성로 517"},
            {name: "초록마을 반포점", address: "서울 서초구 신반포로 177"}, 
            {name: "초록마을 서초점", address: "서울 서초구 서초중앙로 200"},
            {name: "초록마을 방배점", address: "서울 서초구 방배로 230"},
            {name: "초록마을 잠실리센츠점", address: "서울 송파구 올림픽로 145"},
            {name: "초록마을 올림픽공원점", address: "서울 송파구 양재대로 1222"},
            {name: "초록마을 헬리오시티점", address: "서울 송파구 송파대로 345"},
            {name: "초록마을 송파위례점", address: "서울 송파구 위례광장로 136"},
            {name: "초록마을 문정점", address: "서울 송파구 동남로 123"},
            // 마포/서대문/은평
            {name: "초록마을 상암점", address: "서울 마포구 상암산로1길 73"},
            {name: "초록마을 마포염리점", address: "서울 마포구 숭문길 98"},
            {name: "초록마을 공덕점", address: "서울 마포구 백범로 152"},
            {name: "초록마을 홍제점", address: "서울 서대문구 통일로 422"},
            {name: "초록마을 북가좌점", address: "서울 서대문구 응암로 79"},
            {name: "초록마을 은평점", address: "서울 은평구 진관2로 77"},
            {name: "초록마을 녹번역점", address: "서울 은평구 통일로 610"},
            {name: "초록마을 불광점", address: "서울 은평구 불광로 64"},
            // 용산/종로/중구/성동
            {name: "초록마을 신용산점", address: "서울 용산구 서빙고로 17"},
            {name: "초록마을 동부이촌점", address: "서울 용산구 이촌로65가길 72"},
            {name: "초록마을 한남점", address: "서울 용산구 독서당로 73"},
            {name: "초록마을 경희궁자이점", address: "서울 종로구 송월길 99"},
            {name: "초록마을 평창점", address: "서울 종로구 평창문화로 70"},
            {name: "초록마을 약수점", address: "서울 중구 다산로 115"},
            {name: "초록마을 서울금호점", address: "서울 성동구 금호로 94"},
            {name: "초록마을 왕십리점", address: "서울 성동구 왕십리로 339"},
            {name: "초록마을 성수점", address: "서울 성동구 성수일로 56"},
            {name: "초록마을 옥수점", address: "서울 성동구 독서당로 208"},
            // 강서/양천/영등포/구로/동작/관악
            {name: "초록마을 목동롯데캐슬점", address: "서울 양천구 목동중앙북로 38"},
            {name: "초록마을 목동하이페리온점", address: "서울 양천구 오목로 300"},
            {name: "초록마을 신정점", address: "서울 양천구 신월로 338"},
            {name: "초록마을 당산점", address: "서울 영등포구 당산로44길 3"},
            {name: "초록마을 여의도점", address: "서울 영등포구 국제금융로7길 22"},
            {name: "초록마을 문래점", address: "서울 영등포구 선유로 63"},
            {name: "초록마을 구로점", address: "서울 구로구 경인로 482"},
            {name: "초록마을 상도점", address: "서울 동작구 상도로 254"},
            {name: "초록마을 흑석점", address: "서울 동작구 서달로 166"},
            {name: "초록마을 사당점", address: "서울 동작구 동작대로 137"},
            {name: "초록마을 관악로점", address: "서울 관악구 관악로24길 38"},
            {name: "초록마을 강서점", address: "서울 강서구 강서로 351"},
            {name: "초록마을 염창점", address: "서울 강서구 양천로 694"},
            // 노원/도봉/강북/성북/중랑/광진
            {name: "초록마을 중계점", address: "서울 노원구 한글비석로 245"},
            {name: "초록마을 상계점", address: "서울 노원구 노원로 462"},
            {name: "초록마을 공릉점", address: "서울 노원구 공릉로 186"},
            {name: "초록마을 창동점", address: "서울 도봉구 노해로63가길 41"},
            {name: "초록마을 방학점", address: "서울 도봉구 도봉로 684"},
            {name: "초록마을 미아점", address: "서울 강북구 삼양로 242"},
            {name: "초록마을 길음점", address: "서울 성북구 길음로 40"},
            {name: "초록마을 돈암점", address: "서울 성북구 아리랑로 19"},
            {name: "초록마을 성북점", address: "서울 성북구 성북로 63"},
            {name: "초록마을 자양점", address: "서울 광진구 뚝섬로 552"},
            {name: "초록마을 광장점", address: "서울 광진구 아차산로 477"},
            {name: "초록마을 구의점", address: "서울 광진구 아차산로 363"},
            {name: "초록마을 서울장안점", address: "서울 동대문구 답십리로 304"}
        ];

        // 지부별 아이콘 색상
        const jibuIcons = {
            "남서울": "http://maps.google.com/mapfiles/ms/icons/red-dot.png",   // 빨강
            "북서울": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",   // 파랑
            "서서울": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",   // 주황
            "동서울": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",   // 보라
            "경인":   "http://maps.google.com/mapfiles/ms/icons/pink-dot.png"    // 청록
        };
        
        // 초록마을 SVG 아이콘 (초록색 나무 모양)
        const chorocIcon = {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#008000" width="30px" height="30px"><path d="M12,2L2,12h3v8h6v-6h2v6h6v-8h3L12,2z"/></svg>'),
            scaledSize: new google.maps.Size(30, 30), // 아이콘 크기
            anchor: new google.maps.Point(15, 30)     // 아이콘 중심점 (아래 가운데)
        };

        // 매장 개수 카운트 함수
        function countStores() {
            const counts = {
                "남서울": 0, "북서울": 0, "서서울": 0, "동서울": 0, "경인": 0
            };
            
            hansalimStores.forEach(store => {
                if (counts[store.jibu] !== undefined) counts[store.jibu]++;
            });

            const chorocCount = chorocStores.length;
            
            // 범례 HTML 생성
            const legendBox = document.getElementById('legend-box');
            legendBox.innerHTML = `
                <div class="legend-title">한살림 (${hansalimStores.length}개)</div>
                <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" class="legend-icon">남서울 (${counts["남서울"]}개)</div>
                <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" class="legend-icon">서서울 (${counts["서서울"]}개)</div>
                <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png" class="legend-icon">동서울 (${counts["동서울"]}개)</div>
                <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" class="legend-icon">북서울 (${counts["북서울"]}개)</div>
                <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/pink-dot.png" class="legend-icon">경인 (${counts["경인"]}개)</div>
                
                <div class="legend-title" style="margin-top:10px;">초록마을</div>
                <div class="legend-item"><img src="${chorocIcon.url}" class="legend-icon">초록마을 (${chorocCount}개)</div>
            `;
        }

        function initMap() {
            const mapStyles = [
                { featureType: "transit", stylers: [{ visibility: "off" }] },
                { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }
            ];

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 37.5665, lng: 126.9780 },
                zoom: 11,
                styles: mapStyles
            });
            geocoder = new google.maps.Geocoder();
            
            // 인포윈도우 초기화 (하나만 사용)
            currentInfoWindow = new google.maps.InfoWindow();

            // 범례 개수 표시
            countStores();

            // 한살림 -> 초록마을 순차 로딩
            processBatch(hansalimStores, "hansalim", 0);
        }

        function processBatch(list, type, index) {
            const statusBar = document.getElementById("status-bar");
            
            if (index >= list.length) {
                if(type === "hansalim") {
                    processBatch(chorocStores, "choroc", 0);
                } else {
                    statusBar.style.display = "none";
                }
                return;
            }

            const store = list[index];
            const displayType = type === "hansalim" ? "한살림" : "초록마을";
            statusBar.innerText = `${displayType} 확인 중 (${index + 1}/${list.length}): ${store.name}`;

            geocoder.geocode({ address: store.address }, (results, status) => {
                if (status === "OK") {
                    const location = results[0].geometry.location;
                    const isHansalim = type === "hansalim";
                    const iconUrl = isHansalim ? jibuIcons[store.jibu] : chorocIcon;
                    
                    const storeData = {
                        name: store.name,
                        address: store.address,
                        jibu: isHansalim ? store.jibu : "초록마을",
                        type: type,
                        location: location
                    };

                    const marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: store.name, 
                        icon: iconUrl
                    });
                    
                    geocodedStores.push(storeData);

                    marker.addListener("click", () => {
                        let content = `<div style="padding:5px; min-width:220px; color:black;">
                                        <h3 style="margin:0 0 5px 0;">${store.name} 
                                            <span style="font-size:12px; font-weight:normal; color:#555;">(${storeData.jibu})</span>
                                        </h3>
                                        <div style="font-size:12px; color:#666; margin-bottom:8px;">${store.address}</div>
                                        <hr style="border:0; border-top:1px solid #ddd; margin:5px 0;">`;
                        
                        if (isHansalim) {
                            content += `<strong>[${store.jibu} 내 가까운 매장]</strong><br>`;
                        } else {
                            content += `<strong>[주변 초록마을]</strong><br>`;
                        }
                        
                        content += `<div style="max-height:120px; overflow-y:auto; font-size:12px; line-height:1.6;">`;

                        let neighbors;
                        if (isHansalim) {
                            neighbors = geocodedStores.filter(s => s.type === "hansalim" && s.jibu === store.jibu && s.name !== store.name);
                        } else {
                            neighbors = geocodedStores.filter(s => s.type === "choroc" && s.name !== store.name);
                        }
                        
                        if (neighbors.length > 0) {
                            neighbors.sort((a, b) => {
                                const distA = google.maps.geometry.spherical.computeDistanceBetween(location, a.location);
                                const distB = google.maps.geometry.spherical.computeDistanceBetween(location, b.location);
                                return distA - distB;
                            });

                            neighbors.forEach(neighbor => {
                                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(location, neighbor.location);
                                const distanceKm = (distanceMeters / 1000).toFixed(2);
                                content += `${neighbor.name}: <b>${distanceKm}km</b><br>`;
                            });
                        } else {
                            content += "거리 정보 로딩 중...<br>";
                        }
                        
                        content += `</div></div>`;
                        
                        // 하나의 InfoWindow만 사용 (이전 창 자동 닫힘)
                        currentInfoWindow.setContent(content);
                        currentInfoWindow.open(map, marker);
                    });

                } else {
                    console.error("Geocode error for " + store.name + ": " + status);
                }

                // API 호출 간격 조절
                setTimeout(() => processBatch(list, type, index + 1), 70); 
            });
        }

        window.onload = initMap;
    </script>
</body>
</html>
