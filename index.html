<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>서울 한살림 매장 지도 (Google Maps)</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd6QIRzWvsTTbfVUQkcqGyz-fXuQ4DTbU&libraries=geometry"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif;}
        #map { width: 100%; height: 100%; }
        
        /* 로딩 상태바 스타일 */
        #status-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; font-size: 14px;
        }

        /* 범례 스타일 */
        .legend {
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-icon { width: 20px; height: 20px; margin-right: 5px; }
    </style>
</head>
<body>
    <div id="status-bar">지도 초기화 중...</div>
    
    <div class="legend">
        <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" class="legend-icon">강남 권역</div>
        <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" class="legend-icon">강서 권역</div>
        <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png" class="legend-icon">강동 권역</div>
        <div class="legend-item"><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" class="legend-icon">강북 권역</div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let geocoder;
        // 변환된 매장 정보를 담을 배열 (좌표 포함)
        const geocodedStores = []; 
        
        // 매장 데이터
        const stores = [
            {name: "개포매장", address: "서울 강남구 개포로 265"},
            {name: "대치매장", address: "서울 강남구 삼성로51길 11"},
            {name: "압구정매장", address: "서울 강남구 압구정로 309"},
            {name: "강일매장", address: "서울 강동구 상일로12길 99"},
            {name: "둔촌매장", address: "서울 강동구 강동대로55길 77"},
            {name: "가양매장", address: "서울 강서구 공항대로55길 47"},
            {name: "마곡매장", address: "서울 강서구 마곡서로 101"},
            {name: "우장산매장", address: "서울 강서구 강서로 242"},
            {name: "봉천매장", address: "서울 관악구 양녕로 74"},
            {name: "광나루매장", address: "서울 광진구 천호대로 798-1"},
            {name: "구의매장", address: "서울 광진구 광나루로 603"},
            {name: "자양매장", address: "서울 광진구 능동로 50"},
            {name: "고척매장", address: "서울 구로구 중앙로 100"},
            {name: "금천시흥매장", address: "서울 금천구 시흥대로77길 32"},
            {name: "중계매장", address: "서울 노원구 한글비석로8길 29"},
            {name: "하계매장", address: "서울 노원구 섬밭로 258"},
            {name: "방학매장", address: "서울 도봉구 도봉로150다길 28"},
            {name: "쌍문매장", address: "서울 도봉구 시루봉로 139"},
            {name: "상도매장", address: "서울 동작구 상도로37길 79"},
            {name: "마포매장", address: "서울 마포구 토정로 269"},
            {name: "성산매장", address: "서울 마포구 월드컵북로 216"},
            {name: "아현매장", address: "서울 마포구 마포대로 195"},
            {name: "연희매장", address: "서울 서대문구 연희맛로 34"},
            {name: "홍제매장", address: "서울 서대문구 통일로 348"},
            {name: "방배매장", address: "서울 서초구 서초대로 118"},
            {name: "잠원매장", address: "서울 서초구 신반포로 219"},
            {name: "금호매장", address: "서울 성동구 금호로 102"},
            {name: "길음매장", address: "서울 성북구 길음로 11"},
            {name: "돈암매장", address: "서울 성북구 아리랑로 31-1"},
            {name: "가락매장", address: "서울 송파구 오금로46길 68"},
            {name: "송파매장", address: "서울 송파구 송이로 27"},
            {name: "신천매장", address: "서울 송파구 올림픽로 435"},
            {name: "잠실매장", address: "서울 송파구 백제고분로 150"},
            {name: "잠실새내역매장", address: "서울 송파구 석촌호수로 61"},
            {name: "목동매장", address: "서울 양천구 목동동로 339"},
            {name: "문래매장", address: "서울 영등포구 당산로 34"},
            {name: "보라매매장", address: "서울 영등포구 신길로 29"},
            {name: "구파발매장", address: "서울 은평구 진관3로 15-35"},
            {name: "광화문매장", address: "서울 종로구 경희궁길 15"},
            {name: "신내매장", address: "서울 중랑구 신내로21길 16"},
            {name: "위례매장", address: "경기 성남시 수정구 위례동로 61"}
        ];

        // 권역별 색상 아이콘 설정 (구글 기본 아이콘 활용)
        function getRegionInfo(address) {
            if (address.includes("강남구") || address.includes("서초구")) {
                return { name: "강남", icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" };
            }
            if (address.includes("강동구") || address.includes("송파구") || address.includes("성남시")) {
                return { name: "강동", icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" };
            }
            if (address.includes("강서구") || address.includes("양천구") || address.includes("구로구") || address.includes("금천구") || address.includes("영등포구") || address.includes("관악구") || address.includes("동작구")) {
                return { name: "강서", icon: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png" };
            }
            return { name: "강북", icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" };
        }

        function initMap() {
            // 지도 초기화
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 37.5665, lng: 126.9780 },
                zoom: 11
            });
            geocoder = new google.maps.Geocoder();

            // 순차적으로 주소 변환 시작
            processNext(0);
        }

        function processNext(index) {
            const statusBar = document.getElementById("status-bar");
            
            if (index >= stores.length) {
                statusBar.style.display = "none";
                return;
            }

            const store = stores[index];
            statusBar.innerText = `매장 위치 확인 중... (${index + 1}/${stores.length}) - ${store.name}`;

            geocoder.geocode({ address: store.address }, (results, status) => {
                if (status === "OK") {
                    const location = results[0].geometry.location;
                    const regionData = getRegionInfo(store.address);
                    
                    // 데이터 저장
                    const storeData = {
                        name: store.name,
                        address: store.address,
                        region: regionData.name,
                        location: location, // google.maps.LatLng 객체
                        marker: null
                    };

                    // 마커 생성
                    const marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: store.name,
                        icon: regionData.icon
                    });
                    
                    storeData.marker = marker;
                    geocodedStores.push(storeData);

                    // 클릭 이벤트 (거리 계산)
                    const infoWindow = new google.maps.InfoWindow();
                    marker.addListener("click", () => {
                        let content = `<div style="padding:5px; min-width:200px; color:black;">
                                        <h3 style="margin:0 0 5px 0;">${store.name} <span style="font-size:12px; font-weight:normal;">(${regionData.name})</span></h3>
                                        <div style="font-size:12px; color:#555; margin-bottom:8px;">${store.address}</div>
                                        <hr style="border:0; border-top:1px solid #ddd; margin:5px 0;">
                                        <strong>[${regionData.name} 권역 매장 거리]</strong><br>
                                        <div style="max-height:100px; overflow-y:auto; font-size:11px; line-height:1.6;">`;

                        // 같은 권역 매장 필터링 및 거리 계산
                        const neighbors = geocodedStores.filter(s => s.region === regionData.name && s.name !== store.name);
                        
                        if (neighbors.length > 0) {
                            // 거리순 정렬을 위해 배열 복사 및 sort
                            neighbors.sort((a, b) => {
                                const distA = google.maps.geometry.spherical.computeDistanceBetween(location, a.location);
                                const distB = google.maps.geometry.spherical.computeDistanceBetween(location, b.location);
                                return distA - distB;
                            });

                            neighbors.forEach(neighbor => {
                                // 미터(m) 단위를 킬로미터(km)로 변환
                                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(location, neighbor.location);
                                const distanceKm = (distanceMeters / 1000).toFixed(2);
                                content += `${neighbor.name}: <b>${distanceKm}km</b><br>`;
                            });
                        } else {
                            content += "같은 권역의 다른 매장 정보를 불러오는 중입니다.<br>";
                        }
                        
                        content += `</div></div>`;
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);
                    });

                } else {
                    console.error("Geocode error for " + store.name + ": " + status);
                    // 실패 시 잠시 대기 후 재시도 하거나 건너뛰기 (여기서는 건너뜀)
                }

                // 다음 매장 처리 (API 제한 고려하여 약간의 딜레이)
                setTimeout(() => processNext(index + 1), 100); 
            });
        }

        window.onload = initMap;
    </script>
</body>
</html>
